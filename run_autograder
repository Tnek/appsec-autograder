#!/bin/bash

DEBUG=1
RESULTS_PATH=$(pwd)/results.json

if [ -z $DEBUG ]; then
    mkdir /autograder/source/sample_project
    cp -r /autograder/submission/* /autograder/source/sample_project

    cd /autograder/source
    RESULTS_PATH=/autograder/results/results.json
fi

declare -a SERVICES

python3 grader/callback_service.py > /dev/null 2>&1 &
SERVICES[0]="$!"

cd sample_project
pip3 install -r requirements.txt > /dev/null 2>&1
flask run -p 5000 > /dev/null 2>&1 &
SERVICES[1]="$!"
cd ../grader
sleep 3s

python3 grader_runner.py > $RESULTS_PATH

kill ${SERVICES[0]}
kill ${SERVICES[1]}

cd ..

cat results.json
